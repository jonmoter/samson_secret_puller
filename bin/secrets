#!/usr/bin/env ruby
require_relative "../lib/secrets.rb"

VAULT_ADDRESS = ENV.fetch("VAULT_ADDR")
VAULT_AUTH_PEM = ENV.fetch("VAULT_AUTH_PEM", '/vault-auth/pem')
VAULT_TLS_VERIFY = ENV.fetch("VAULT_TLS_VERIFY", false)
SIDECAR_SECRET_PATH = ENV.fetch("SIDECAR_SECRET_PATH", '/secrets/')
ANNOTATIONS = ENV.fetch("SECRET_ANNOTATIONS", '/secretkeys/annotations')

raise "VAULT_ADDR not provided" unless VAULT_ADDRESS

client = SecretsClient.new(VAULT_ADDRESS, VAULT_AUTH_PEM, VAULT_TLS_VERIFY, ANNOTATIONS, SIDECAR_SECRET_PATH)

loop do
  client.process
  sleep 600
end
